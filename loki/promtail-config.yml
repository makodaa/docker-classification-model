server:
    http_listen_port: 9080
    grpc_listen_port: 0

positions:
    filename: /tmp/positions.yaml

clients:
    - url: http://loki:3100/loki/api/v1/push

scrape_configs:
    # Scrape all Docker container logs
    - job_name: docker
      docker_sd_configs:
          - host: unix:///var/run/docker.sock
            refresh_interval: 5s
      relabel_configs:
          # Extract container name
          - source_labels: ["__meta_docker_container_name"]
            regex: "/(.*)"
            target_label: "container"
          # Extract log stream (stdout/stderr)
          - source_labels: ["__meta_docker_container_log_stream"]
            target_label: "stream"
          # Extract service name from docker-compose label
          - source_labels:
                ["__meta_docker_container_label_com_docker_compose_service"]
            target_label: "service"
          # Extract container ID
          - source_labels: ["__meta_docker_container_id"]
            target_label: "container_id"

    # Specific configuration for backend service with JSON parsing
    - job_name: backend
      docker_sd_configs:
          - host: unix:///var/run/docker.sock
            refresh_interval: 5s
            filters:
                - name: name
                  values: ["backend"]
      relabel_configs:
          - source_labels: ["__meta_docker_container_name"]
            target_label: "container"
          - source_labels: ["__meta_docker_container_log_stream"]
            target_label: "stream"
          - source_labels:
                ["__meta_docker_container_label_com_docker_compose_service"]
            target_label: "service"
      pipeline_stages:
          # Parse JSON logs from Python backend
          - json:
                expressions:
                    level: levelname
                    message: message
                    timestamp: asctime
                    logger: name
                    module: module
                    function: funcName
          # Extract labels for filtering
          - labels:
                level:
                logger:
                module:
          # Set timestamp from log entry
          - timestamp:
                source: timestamp
                format: "2006-01-02 15:04:05,000"
          # Add output formatting
          - output:
                source: message

    # Configuration for database logs
    - job_name: database
      docker_sd_configs:
          - host: unix:///var/run/docker.sock
            refresh_interval: 5s
            filters:
                - name: name
                  values: ["database"]
      relabel_configs:
          - source_labels: ["__meta_docker_container_name"]
            target_label: "container"
          - source_labels: ["__meta_docker_container_log_stream"]
            target_label: "stream"
      pipeline_stages:
          # Parse PostgreSQL log format
          - regex:
                expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3} \w+) \[(?P<pid>\d+)\] (?P<level>\w+):  (?P<message>.*)'
          - labels:
                level:
          - timestamp:
                source: timestamp
                format: "2006-01-02 15:04:05.000 MST"
