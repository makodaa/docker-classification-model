services:
    backend:
        build: ./backend
        container_name: backend
        ports:
            - "8000:8000"
        environment:
            DATABASE_URL: postgresql://postgres:postgres@database:5432/image_classification
        depends_on:
            - database
        networks:
            - app-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "2.0"
                    memory: 2G

    frontend:
        build: ./frontend
        container_name: frontend
        ports:
            - "3000:80"
        depends_on:
            - backend
        networks:
            - app-network
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 512M
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:80/",
                ]
            interval: 30s
            timeout: 5s
            retries: 3
        restart: unless-stopped

    database:
        image: postgres:15-alpine
        container_name: database
        environment:
            POSTGRES_DB: image_classification
            POSTGRES_PASSWORD: postgres
        networks:
            - app-network
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: 1G
        volumes:
            - db_data:/var/lib/postgresql/data
            - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    backup:
        image: postgres:15-alpine
        container_name: backup-service
        environment:
            - PGPASSWORD=postgres
            - POSTGRES_DB=image_classification
            - POSTGRES_USER=postgres
            - BACKUP_RETENTION_DAYS=7
        volumes:
            - ./backups:/backups
            - ./scripts/backup.sh:/scripts/backup.sh:ro
        networks:
            - app-network
        command: sh /scripts/backup.sh
        restart: unless-stopped
        depends_on:
            - database

    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
            - prometheus_data:/prometheus
        ports:
            - "9090:9090"
        networks:
            - app-network
        restart: unless-stopped
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"

    grafana:
        image: grafana/grafana:9.5.0
        container_name: grafana
        environment:
            GF_SECURITY_ADMIN_PASSWORD: admin
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning:ro
            - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
        ports:
            - "3002:3000"
        networks:
            - app-network
        restart: unless-stopped

    loki:
        image: grafana/loki:2.9.0
        container_name: loki
        ports:
            - "3100:3100"
        volumes:
            - ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro
            - loki_data:/loki
        command: -config.file=/etc/loki/local-config.yaml
        networks:
            - app-network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: 1G

    promtail:
        image: grafana/promtail:2.9.0
        container_name: promtail
        volumes:
            - ./loki/promtail-config.yml:/etc/promtail/config.yml:ro
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        command: -config.file=/etc/promtail/config.yml
        networks:
            - app-network
        depends_on:
            - loki
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 256M

networks:
    app-network:
        driver: bridge

volumes:
    db_data:
    prometheus_data:
    grafana_data:
    loki_data:
